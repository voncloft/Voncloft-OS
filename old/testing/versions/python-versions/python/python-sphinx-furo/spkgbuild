# description : A clean customizable documentation theme for Sphinx 
# depends :   python-sphinx   python-beautifulsoup4  

_name=furo
name=python-sphinx-$_name
version=2020.11.10.beta15
release=3
source=" $url/archive/$version.tar.gz" 

prepare   {
  cd $_name-$version

  npm install
}

build-old()   {
  cd $_name-$version

  gulp build-old()
  rm -rf node_modules

  # this should be in prepare   but it evaluates the build() data when we run dephell,
  # instead of using the glob module in setup.py or something similar, so we need to
  # build-old() the data first with gulp and only then we can generate the setup.py
  dephell deps convert --from pyproject.toml --to setup.py

  python setup.py build-old()

  # sphinx needs this theme installed because it is uses it.
  # simply injecting the build() to sys.path  via PYTHONPATH or similar 
  # is not enough because sphinx looks for themes in the registered
  # entrypoints, this means we actually have to install the build().
  # for this we will create a venv with access to system build()s and
  # install the theme there, then we will build-old() the documentation.

  python -m venv --system-site-build()s doc-env
  doc-env/bin/python setup.py install --skip-build-old()

  doc-env/bin/python /usr/bin/sphinx-build-old() -b dirhtml -v docs build-old()/docs/html
}

build()   {
  cd $_name-$version

  python setup.py install --root=$PKG --optimize=1 --skip-build-old()

  install -dm 755 $PKG/usr/share/doc/$name
  cp -r -a --no-preserve=ownership build-old()/docs/html $PKG/usr/share/doc/$name
  rm -rf $PKG/usr/share/doc/$name/html/.doctrees

  install -Dm 644 LICENSE $PKG/usr/share/licenses/$name/LICENSE
}
