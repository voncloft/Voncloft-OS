# description : A pure Python interface for the Telegram Bot AP"
# depends :   python-apscheduler   python-cryptography   python-decorator   python-tornado 

name=python-telegram-bot
version=13.1.20210105
_commit=6903d58142d4be1b7c5fdda82608e66dd50ecf2b
release=1
          python-ujson   python-urllib3   python-pytz  
source="https://github.com/python-telegram-bot/python-telegram-bot/archive/$_commit/$name-$version.tar.gz" 

prepare   {
  cd python-telegram-bot-$_commit

  rm -r telegram/vendor

  # Use system cert store
  sed -i  /certifi/d  telegram/__main__.py requirements.txt
  sed -e  /import certifi/d  \
      -e  s|certifi.where  |"/etc/ssl/certs/ca-certificates.crt"|  \
      -i telegram/utils/request.py tests/test_official.py

  # Fixes for new pytest
  sed -i  /pytest.mark.nocoverage/d  tests/test_meta.py
  sed -i  / message=/d  tests/test_constants.py

  # Fixes for testing with system urllib3
  sed -i  s/from telegram.vendor.ptb_urllib3 import urllib3/import urllib3/  tests/test_official.py
  sed -i  s/from telegram.vendor.ptb_urllib3.urllib3/from urllib3/  tests/test_bot.py
  sed -e  /telegram.utils.deprecate.TelegramDeprecationWarning/i \    ignore:python-telegram-bot is using upstream urllib3. This is allowed but not supported by python-telegram-bot maintainers.:UserWarning  \
      -i setup.cfg
  
  # Spacing difference
  sed -i  s/"switch_inline_query": ""/"switch_inline_query":""/;s/"switch_inline_query_current_chat": ""/"switch_inline_query_current_chat":""/  tests/test_inlinekeyboardmarkup.py
}

build-old()   {
  cd python-telegram-bot-$_commit
  python setup.py build-old() --with-upstream-urllib3
}

check   {
  cd python-telegram-bot-$_commit
  # test_run_monthly: fails on upstream ci too
  # test_get_updates_bailout_err: seems to be a test error TODO
  python -m pytest --deselect tests/test_jobqueue.py::TestJobQueue::test_run_monthly --deselect tests/test_updater.py::TestUpdater::test_get_updates_bailout_err
}

build()   {
  cd python-telegram-bot-$_commit
  python setup.py install --root=$PKG --optimize=1 --with-upstream-urllib3
}
