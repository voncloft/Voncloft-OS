# description : "Virtual Python Environment builder"

pkgbase=python-virtualenv
name=('python-virtualenv' 'python2-virtualenv')
version=20.4.2
release=1
             'python2-setuptools' 'python2-appdirs' 'python2-distlib' 'python2-filelock' 'python2-six'
             'python2-importlib-metadata' 'python2-importlib_resources' 'python2-pathlib2'
             'python-setuptools-scm' 'python2-setuptools-scm' 'python-sphinx'
             'python-sphinx_rtd_theme' 'python-sphinx-argparse' 'towncrier')
              'xonsh' 'python-flaky')  # 'tcsh' removed: randomly hangs tests
replaces=('virtualenv')
conflicts=('virtualenv')
options=('!makeflags')

export SETUPTOOLS_SCM_PRETEND_VERSION=$version

prepare() {
  # TODO: figure out why
  sed -i '/test_py_info_to_system_raises/i @pytest.mark.skip' virtualenv-$version/tests/unit/discovery/py_info/test_py_info.py

  # workaround pip vendorod certifi
  sed -i "s|pkgutil.get_data(\"pip._vendor.certifi\", \"cacert.pem\")|open(os.path.join('/etc/ssl/certs/ca-certificates.crt'), 'rb').read()|" virtualenv-$version/tests/conftest.py

  cp -a virtualenv-$version{,-py2}
}

build-remove() {
  (cd virtualenv-$version
    python setup.py build egg_info
    export PYTHONPATH="$PWD/build/lib:$PWD/src"
    sphinx-build -b man docs docs/_build/man
  )
  (cd virtualenv-$version-py2
    python2 setup.py build egg_info
  )
}

check() {
  cd virtualenv-$version
  PYTHONPATH="$PWD/build/lib:$PWD/src" python -m pytest
}

package_python-virtualenv() {
  # depends : ('python-appdirs' 'python-distlib' 'python-filelock' 'python-six')

  cd virtualenv-$version
  python setup.py install --prefix=/usr --root=$PKG --skip-build
  install -Dm 644 docs/_build/man/virtualenv.1 "${pkgdir}/usr/share/man/man1/virtualenv.1"
  ln -s virtualenv.1.gz "${pkgdir}/usr/share/man/man1/virtualenv3.1.gz"

  # link to a version with 3 suffix as well
  ln $PKG/usr/bin/virtualenv" $PKG/usr/bin/virtualenv3"

}

package_python2-virtualenv() {
  # depends : ('python2-appdirs' 'python2-distlib' 'python2-filelock' 'python2-six'
           'python2-importlib-metadata' 'python2-importlib_resources' 'python2-pathlib2')

  cd virtualenv-$version-py2
  python2 setup.py install --prefix=/usr --root=$PKG --skip-build
  install -Dm 644 ../virtualenv-$version/docs/_build/man/virtualenv.1 "${pkgdir}/usr/share/man/man1/virtualenv2.1"

  # move this "old" version out of the way
  mv $PKG/usr/bin/virtualenv" $PKG/usr/bin/virtualenv2"

}
