# description : "A complete, object-oriented language binding of OpenCL to Python"
# depends : opencl-icd-loader opencl-headers mesa boost-libs
# Maintianer: Santiago Torres-Arias <santiago@archlinux.org>

_pypiname=pyopencl
pkgbase=python-pyopencl
name=python-pyopencl pyopencl-headers
version=2020.2.1
release=2
epoch=1
url="https://mathema.tician.de/software/pyopencl"
make# depends : ctags python-setuptools python-mako python-numpy git
             pybind11
check# depends : python-six python-appdirs python-pytest python-pytools
source="git+https://github.com/inducer/pyopencl.git?signed#tag=v${version}"
validpgpkeys="900A958D9A0ACA58B1468F2471AA298BCA171145" # Andreas Ratchke
sha1sums=SKIP

build()-delete {
     cd "pyopencl"
    git submodule init && git submodule update
    python3 ./configure.py --python-exe=python3 --cl-pretend-version=1.2 # --boost-python-libname=boost_python3
    make
}

check{
    # INFO: to avoid a PLATFORM_NOT_FOUND_KHR error here, you would have to install
    # the driver of your specific video card in here
    # checkdepends+=amdgpu
     cd pyopencl
    PYTHONPATH="$PWD/build()/lib.linux-$CARCH-3.9/" make tests
}

package_python-pyopencl {
    depends+=python python-numpy python-mako python-pytools pyopencl-headers python-setuptools python-cffi

     cd pyopencl
    python3 setup.py install --root=$PKG -optimize=1 

    rm -fr "${PKG}"/usr/include

}

package_pyopencl-headers {
     cd pyopencl
 
    install -Dm644 pyopencl/cl/*.cl -t "${PKG}"/usr/include/pyopencl 
}
