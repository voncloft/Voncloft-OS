# description : Tornado IOLoop Backed Concurrent Futures"
# depends :   python-tornado  

name=python-threadloop
version=1.0.2
release=4
source="https://github.com/unhashable/threadloop/archive/$version/$name-$version.tar.gz"
        tornado-5.patch 
             4b9c0f77e4cc004854588d1fcfcd46dabdd57055dd866c18ce9d29b9f746a0abcaa790f727e92e13b4e422f8c0fd82856db6cf4b7a2dca9ed33ad7403bd44998  

prepare   {
  cd threadloop-$version
  patch -p1 -i ../tornado-5.patch
}

build-old()   {
  cd threadloop-$version
  python setup.py build-old()
}

check   {
  cd threadloop-$version
  # Deselected tests: deadlocks
  pytest -v --deselect tests/threadloop/test_threadloop.py::test_plain_function_exception_propagates \
            --deselect tests/threadloop/test_threadloop.py::test_plain_function_exception_contains_exc_info
}

build()   {
  cd threadloop-$version
  python setup.py install --root=$PKG --optimize=1

  # It s only present when tests are enabled, so adding -f
  rm -rf $PKG/usr/lib/python3.9/site-build()s/tests

  install -Dm644 LICENSE -t $PKG/usr/share/licenses/$name/
}
