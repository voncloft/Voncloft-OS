#!/bin/sh
vercomp() {
        if [ "$1" = "$2" ]; then
                return 0 # same version
        #elif [ "$1" = "$(echo "$1\n$2" | sort -V | head -n1)" ]; then
        elif [ "$(printf '%s\n' "$1" "$2" | sort -V | head -n1)" = "$1" ]; then
                return 1 # $1 lower than $2
                #echo "1"
        else
                return 2 # $1 higher than $2
                #echo "2"
        fi
}
cd /var/log/old
shopt -s nocaseglob
rm testing.txt
wget http://distrowatch.org/packages.php

#remove packages that you want out of the loop
sed -i -e '/vlc/d' packages.php

rm -rf stripped_info.txt
grep -A 1 "<th><a name=" packages.php >> modified.php

#fix a few packages
sed -i -e 's/qt/qt5/g' modified.php

grep -Po "(?<=>)[^<>]*(?=<)" modified.php | grep -v : | tr '[:upper:]' '[:lower:]'>> stripped_info.txt

##get some additional packages##
sh /Voncloft-OS/utilities/custom_progs/nss.sh
sh /Voncloft-OS/utilities/custom_progs/nspr.sh
sh /Voncloft-OS/utilities/custom_progs/sudo.sh
sh /Voncloft-OS/utilities/custom_progs/bluefish.sh

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
NC='\033[0m'
input=stripped_info.txt
myarr=()
list=$(cat </etc/checkrepo.conf)
while IFS= read  -r line; do
   myarr+=("$line")
done < "$input"
count=0
while IFS=, read -ra items; do
		for item in "${items[@]}"; do
			for ((index=0; index <= ${#myarr[@]}; index++)); do
			#echo "${myarr[index]}"
  			if [ "${myarr[index]}" == "$item" ]; 
  			then
    				uversion=${myarr[index+1]}
				cversion=$(grep "version=" /Voncloft-OS/*/$item/spkgbuild | sed 's/version=//g' | grep -v version | grep -v { )
				if [ "$uversion" != "$cversion" ];
				then
				vercomp $uversion $cversion
					if [ $? = 2 ]; then #if I have a more current up to date package on my repo then leave it out of the report
						((count=count+1))
						final="<b><u>${myarr[index]}</u></b>\n"
						final+="<br>installed version in repo: $cversion\n"
						final+="<br>upgraded to version: $uversion\n"
						final+="<br><br>\n\n"
						echo -e $final >> testing.txt
						echo -e $final >> /Voncloft-OS/logs/repository_upgrade_report-$(date +"%m-%d-%y").log
						echo -e "sed -i -e 's/$cversion/$uversion/g' /Voncloft-OS/*/$item/spkgbuild" >> /Voncloft-OS/logs/repository_changes-$(date +"%m-%d-%y").log
						sed -i -e "s/$cversion/$uversion/g" /Voncloft-OS/*/$item/spkgbuild
					fi
				fi
  			fi
                        done
                        #echo $final
		done
		#echo $final
done <<< "$list"
#echo $PWD
echo -e "Packages upgraded: $count\n" >> $PWD/testing.txt
echo -e "Packages upgraded: $count\n" >> /Voncloft-OS/logs/repository_upgrade_report-$(date +"%m-%d-%y").log
echo -e "Packages upgraded: $count\n" >> /Voncloft-OS/logs/repository_changes-$(date +"%m-%d-%y").log
words=$(cat $PWD/testing.txt)
cat $PWD/testing.txt
title="Outdated Packages in Repository: "$(date +"%m-%d-%y")
echo $title
mailme voncloft@gmail.com "$words" "$title"
rm -rfv *.php
rm -rfv *.php.*
rm -rfv stripped_info.txt

#mv -v testing.txt repository_upgrade_report.log
rm testing.txt

cp /Voncloft-OS/logs/repository_upgrade_report-$(date +"%m-%d-%y").log /var/log/old/repository_upgrade_report-$(date +"%m-%d-%y").log
cp /Voncloft-OS/logs/repository_changes-$(date +"%m-%d-%y").log /var/log/old/repository_changes-$(date +"%m-%d-%y").log
