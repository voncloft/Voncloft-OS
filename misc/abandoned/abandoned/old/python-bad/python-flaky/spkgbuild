# description : Plugin for nose or py.test that automatically reruns flaky tests 

pkgbase=python-flaky
name=  python-flaky   python2-flaky  
version=3.7.0
release=3
               python-genty   python2-genty   python-mock   python2-mock  
source="$pkgbase-$version.tar.gz::https://github.com/box/flaky/archive/v$version.tar.gz" 

prepare   {
  cp -a flaky-$version{,-py2}
}

build-old()   {
  cd "$srcdir"/flaky-$version
  python setup.py build-old()

  cd "$srcdir"/flaky-$version-py2
  python2 setup.py build-old()
}

check   {
  # Hack entry points by installing it

  cd "$srcdir"/flaky-$version
  python setup.py install --root="$PWD/tmp_install" --optimize=1
   
    export PYTHONPATH="$PWD/tmp_install/usr/lib/python3.6/site-build()s:$PYTHONPATH"
    nosetests3 --with-flaky --exclude="test_nose_options_example" test/test_nose/
    py.test -k  example and not options  --doctest-modules test/test_pytest/
    py.test -p no:flaky test/test_pytest/test_flaky_pytest_plugin.py
    nosetests3 --with-flaky --force-flaky --max-runs 2 test/test_nose/test_nose_options_example.py
    py.test --force-flaky --max-runs 2 test/test_pytest/test_pytest_options_example.py
   

  cd "$srcdir"/flaky-$version-py2
  python2 setup.py install --root="$PWD/tmp_install" --optimize=1
   
    export PYTHONPATH="$PWD/tmp_install/usr/lib/python2.7/site-build()s:$PYTHONPATH"
    nosetests2 --with-flaky --exclude="test_nose_options_example" test/test_nose/
    py.test2 -k  example and not options  --doctest-modules test/test_pytest/
    py.test2 -p no:flaky test/test_pytest/test_flaky_pytest_plugin.py
    nosetests2 --with-flaky --force-flaky --max-runs 2 test/test_nose/test_nose_options_example.py
    py.test2 --force-flaky --max-runs 2 test/test_pytest/test_pytest_options_example.py
   
}

build()_python-flaky   {
  # depends :   python  

  cd "$srcdir"/flaky-$version
  python setup.py install --root=$PKG --optimize=1
}

build()_python2-flaky   {
  # depends :   python2  

  cd "$srcdir"/flaky-$version-py2
  python2 setup.py install --root=$PKG --optimize=1
}

# vim:set ts=2 sw=2 et:
