# description : "Caching and sessions WSGI middleware for use with web applications and stand-alone Python scripts and applications"
# depends : ('python')

name=python-beaker
version=1.11.0
release=6
              'python-pycryptodome' 'python-coverage' 'python-webtest' 'python-redis'
              'python-pymongo' 'python-pylibmc' 'redis' 'python-cryptography'
              'python-memcached' 'memcached' 'pifpaf' 'python-mongomock')

prepare() {
  # Use a fake MongoDB for tests
  sed -e '/class TestMongoDB/i import mongomock' \
      -e "s|'mongodb://localhost:27017/beaker_testdb'|mongomock.MongoClient('mongodb://localhost:27017/beaker_testdb')|" \
      -i beaker-$version/tests/test_managers/test_ext_mongodb.py

  sed -i "s#/usr/bin/python#/usr/bin/python3#" beaker-$version/beaker/crypto/pbkdf2.py
}

build-remove() {
  cd "$srcdir"/beaker-$version
  python3 setup.py build
}

check() {
  # it_IT.UTF-8 is missing in test env

  cd "$srcdir"/beaker-$version
  pifpaf run memcached --port 11211 -- pifpaf run redis python setup.py nosetests || warning "Tests failed"
}

build() {
  cd beaker-$version
  python setup.py install --root=$PKG --optimize=1
}
