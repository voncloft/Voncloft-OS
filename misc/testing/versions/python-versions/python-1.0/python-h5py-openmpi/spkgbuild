
_pkg=h5py
_mpi=openmpi
name=python-${_pkg}-${_mpi}
version=3.1.0
release=3
# description : General-purpose Python bindings for the HDF5 library  ${_mpi} version "
# depends :  hdf5-${_mpi} liblzf python-numpy python-mpi4py 
conflicts= python-h5py 
provides= python-h5py 
source=https://files.pythonhosted.org/packages/source/h/${_pkg}/${_pkg}-${version}.tar.gz 
validpgpkeys= AC47F71DB275ECD0B3DA46E857FA4540DD4EFCF7 # Thomas A Caswell  Brookhaven National Lab  <tcaswell@bnl.gov>
              96B7334D7610EE3E68AFFE589E027116943D6A8B  # Thomas A Caswell <tcaswell@bnl.gov>  new key 
# Seehttps://github.com/h5py/h5py/issues/1299 about lack of GPG sigs for recent releases

prepare   {
  cd ${_pkg}-${version}
  # Remove RPATH
  sed -i "s/settings\\[ runtime_library_dirs \\] = settings\\[ library_dirs \\]/pass/" setup_build.py
}

build   {
  export CC=mpicc
  cd ${_pkg}-${version}
  HDF5_MPI="ON" H5PY_SYSTEM_LZF=1 python setup.py build
}

check   {
  local python_version=$ python -c  import sys; print ".".join map str, sys.version_info[:2]     
  PYTHONPATH="$PWD/${_pkg}-${version}/build/lib.linux-$CARCH-${python_version}" python -m pytest --pyargs h5py -rxXs --with-mpi
}

package   {
  cd ${_pkg}-${version}
  HDF5_MPI="ON" python setup.py install --root=$PKG --skip-build --optimize=1
  install -Dm644 licenses/license.txt -t $PKG/usr/share/licenses/${name}/
}
