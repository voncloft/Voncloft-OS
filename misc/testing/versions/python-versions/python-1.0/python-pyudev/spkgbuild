
_name=pyudev
name=python-$_name
version=0.22
release=5
# description : Python bindings to libudev 
# depends :   python-six   systemd  
             pyside2: PySide integration 
             python-wxpython: WX integration  
source="$_name-$version.tar.gz::$url/archive/v$version.tar.gz" 

prepare   {
  cd $_name-$version

  # pytest-runner doesn t understand norecursedirs
  sed -i  /norecursedirs/d  setup.cfg
  echo -e  [pytest]\nnorecursedirs = .* _* build  > pytest.ini

  # Remove failing tests  we can t test udev inside makepkg 
  rm tests/test_{util,discover,device,monitor,enumerate,observer}.py

  # Fix documentation build
  sed -i "s|os.path.join doc_directory, os.pardir |os.path.join doc_directory, os.pardir,  src  |
          s|b autodoc-process-docstring | autodoc-process-docstring |" doc/conf.py
}

build   {
  cd $_name-$version

  python setup.py build

  # Generate documentation
  sphinx-apidoc -f -e -o doc src/pyudev
  sphinx-build -a -b html doc doc/html
}

check   {
  cd $_name-$version

  python setup.py pytest
}

package   {
  cd $_name-$version

  python setup.py install --root $PKG --skip-build -O1

  # Install documentation
  install -dm 755 $PKG/usr/share/doc/$name
  cp -r -a --no-preserve=ownership doc/html $PKG/usr/share/doc/$name
  rm -rf $PKG/usr/share/doc/$name/html/.doctrees
}
