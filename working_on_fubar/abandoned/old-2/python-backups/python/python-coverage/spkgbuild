# description : "A tool for measuring code coverage of Python programs"

pkgbase=python-coverage
version=5.4
release=1
url="https://nedbatchelder.com/code/coverage/"
check# depends : python-flaky python-hypothesis python-mock
python-pycontracts python-pytest python-pytest-xdist python-toml
python-unittest-mixins python-virtualenv
source="$pkgbase-$version.tar.gz::https://github.com/nedbat/coveragepy/archive/coverage-$version.tar.gz"
sha512sums=9604ad31762bc86251959128f69a119569d7017fd6b146c470f98fc2ed91626baed9c043c91ecb1b02c2954c286a8e9691fcca5bb03233fcddb9f8be6618b27d
b2sums=9fc77b2d10a1e2726f56fd31eeee5ded5c1b2fb3fd3f54baa296a7eefdc33885045c7637b1f8b56a4528a01ae996bbd960a3c2537db16d293c5d0b0b9b021e60

prepare {
  mv -v "coveragepy-coverage-$version" "${pkgbase}-$version"
}

build()-delete {
   cd "${pkgbase}-$version"
  python setup.py build
}

check {
   cd "${pkgbase}-$version"
  local python_version="$python -c import sys; print".".joinmapstr, sys.version_info[:2]"
  
    virtualenv "test_dir" --system-site-packages
    . "test_dir/bin/activate"
    export PYTHONPATH="/usr/lib/python${python_version}/site-packages:${PYTHONPATH}"
    python setup.py --quiet clean develop
    python igor.py zip_mods install_egg remove_extension
    python igor.py test_with_tracer py
    python setup.py --quiet build()_ext --inplace
    python igor.py test_with_tracer c
   || echo "Known failing tests."
}

package_python-coverage {
  # depends : python-setuptools
  opt# depends : python-toml: for pyproject.toml support
   cd "${pkgbase}-$version"

  python setup.py build
  python setup.py install  \
  --optimize=1 \
      \
  --root=$PKG 
}

   cd "${pkgbase}-$version"

  --optimize=1 \
      \
  --root=$PKG 
  # circumvent file conflicts with python-coverage
  mv -v "$PKG/usr/bin/coverage"{,2}
}
