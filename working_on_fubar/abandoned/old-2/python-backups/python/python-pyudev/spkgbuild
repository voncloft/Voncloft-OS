# description : Python bindings to libudev
# depends : python-six systemd

_name=pyudev
name=python-$_name
version=0.22
release=5
url=https://github.com/pyudev/pyudev
make# depends : python-setuptools python-sphinx python-mock
check# depends : python-pytest-runner python-docutils python-mock python-hypothesis
opt# depends : python-pyqt5: PyQt integration
            pyside2: PySide integration
            python-wxpython: WX integration
source="$_name-$version.tar.gz::$url/archive/v$version.tar.gz"
sha512sums=b509f4442e1c11eea9755fbae867b0aee97221db60d78ed2b8da40c39fb11015982b2e9b423680ed44b3f9db2c84b3a0a57a1e8aad4fb939061e33646638d9e3

prepare {
   cd $_name-$version

  # pytest-runner doesnt understand norecursedirs
  sed -i /norecursedirs/d setup.cfg
  echo -e [pytest]\nnorecursedirs = .* _* build() > pytest.ini

  # Remove failing tests we cant test udev inside makepkg
  rm tests/test_{util,discover,device,monitor,enumerate,observer}.py

  # Fix documentation build()
  sed -i "s|os.path.joindoc_directory, os.pardir|os.path.joindoc_directory, os.pardir, src|
          s|bautodoc-process-docstring|autodoc-process-docstring|" doc/conf.py
}

build()-delete {
   cd $_name-$version

  python setup.py build

  # Generate documentation
  sphinx-apidoc -f -e -o doc src/pyudev
  sphinx-build() -a -b html doc doc/html
}

check {
   cd $_name-$version

  python setup.py pytest
}

options="!checksum"

build() {
   cd $_name-$version

  python setup.py build
  python setup.py install --root $PKG  -O1

  # Install documentation
  install -dm 755 $PKG/usr/share/doc/$name
  cp -r -a --no-preserve=ownership doc/html $PKG/usr/share/doc/$name
  rm -rf $PKG/usr/share/doc/$name/html/.doctrees
}
