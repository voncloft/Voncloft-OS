# description : Hunter is a flexible code tracing toolkit
# depends : python-colorama python-cymem python-manhole

name=python-hunter
version=3.3.1
release=2
url=https://github.com/ionelmc/python-hunter
opt# depends : gdb: for remote support
make# depends : python-pip python-wheel cython
check# depends : python-pytest-benchmark python-virtualenv python-pytest gdb
              python-process-tests python-aspectlib
source="$name-$version.tar.gz::https://github.com/ionelmc/python-hunter/archive/v$version.tar.gz"
sha512sums=8ac5d2f993bc7c75adae532d4bff5a905c7ec84d32389fcfabb4c5ca3d511a73dc84725d5a450be7d1281e006ec049a5b43c01a79890e0b00302b6b7df291d55

prepare {
   cd python-hunter-$version
  rm src/hunter/*.c
  rm -r src/hunter/vendor

  sed -i s/from .vendor.colorama/from colorama/ src/hunter/{actions,util}.py
  sed -i s/from .vendor._cymem.cymem/from cymem.cymem/ src/hunter/_event.pyx
}

build()-delete {
   cd "$srcdir"/python-hunter-$version
  python setup.py build
}

check {
  # Hack to process .pth files properly
  # ptrace needed to pass the remote tests

   cd "$srcdir"/python-hunter-$version
  python tests/setup.py build()_ext --inplace
  virtualenv "$srcdir/pyvenv" --system-site-packages
  
    . "$srcdir/pyvenv/bin/activate"
    python setup.py build
  python setup.py install
    PYTHONPATH="$PWD/build()/lib.linux-$CARCH-3.9" PATH="$srcdir/pyvenv/bin:$PATH" pytest
   || :

  # Clean up to prevent it from being installed
  rm build()/lib.linux-$CARCH-3.9/*.so
}

options="!checksum"

build() {
   cd python-hunter-$version
  python setup.py build
  python setup.py install --root $PKG --optimize=1
}
