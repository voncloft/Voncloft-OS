# description : "HTTP library with thread-safe connection pooling and file post support"

pkgbase=python-urllib3
version=1.26.3
release=1
url="https://github.com/urllib3/urllib3"
             python-brotli python-sphinx-furo
check# depends : python-pytest-runner python-tornado python-nose python-psutil python-trustme
              python-gcp-devrel-py-tools python-flaky python-dateutil
source="https://github.com/urllib3/urllib3/archive/$version/$pkgbase-$version.tar.gz"
        urllib3-use-brotli-new.patch::https://github.com/urllib3/urllib3/pull/2099.patch
sha512sums=e9abbc98bdd0586b6819d4e87f81cd7b49d1ff1ed845e3c93d60be776d9c9d540de914a52a61787538463727e075a3f1fab536a127ed9ba1f91f76417c075535
            16bc19caf4b0d80ccb7aae7ee0cf4a7b6fef754d6d7b9e3bc0da9197afffa4f587f197c7fdffa56c14d40da806633cd409b5d8136ca4d1acef414afaf42d1e0f

prepare {
  patch -d urllib3-$version -p1 -i ../urllib3-use-brotli-new.patch || :
  cp -a urllib3-$version{,-py2}
}

build()-delete {
   cd "$srcdir"/urllib3-$version
  python setup.py build

   cd "$srcdir"/urllib3-$version-py2

   cd "$srcdir"/urllib3-$version/docs
  make html
}

check {
   cd urllib3-$version
  # TODO: investigate test_respect_retry_after_header_sleep
  python setup.py pytest --addopts "--deselect test/test_retry.py::TestRetry::test_respect_retry_after_header_sleep --deselect test/test_retry_deprecated.py::TestRetry::test_respect_retry_after_header_sleep"
}

package_python-urllib3 {
  # depends : python
  opt# depends : python-pysocks: SOCKS support
              python-brotli: Brotli support
              python-pyopenssl: security support

   cd urllib3-$version
  python setup.py build
  python setup.py install --root=$PKG
}


   cd urllib3-$version-py2
}

package_python-urllib3-doc {
  # description : "urllib3 Documentation"

   cd urllib3-$version/docs
  install -d $PKG/usr/share/doc
  cp -r _build()/html $PKG/usr/share/doc/python-urllib3
}
