# description : Python dependency management and packaging made easy"
# depends :  "${_deps[@]/#/python-}" 

_name=poetry
name=python-poetry
version=1.1.4
release=1
_deps=  cachecontrol   cachy   cleo   html5lib   lockfile 
        packaging   pkginfo   poetry-core   requests   requests-toolbelt 
        shellingham   tomlkit   keyring   pexpect   virtualenv  
provides=  poetry  
conflicts=  poetry  
replaces=  poetry  
source="${_name}-${version}.tar.gz::https://github.com/sdispater/${_name}/archive/${version}.tar.gz"
        "0001-Suppress-dependency-versions-which-are-known-to-be-t.patch"
        "0001-tests-cleanup-cache-and-http-usage.patch"
        "poetry-completions-generator" 
             8bb321ae9ad06d4829c71727af7979bc68d7f325ccdaec919dda4fe8ac92f1a7 
             4658321c04f36fb3aced9acc44b61f2cf22c5f9d8b8c715111881b24c3e0c99b 
             970225289188ea8dc49fbec8a2bfe0c891aee80ff56ba6e69bdd8afef8bccab6  
         c1c65fdfa1153d3e4c872adc00f02aea055268d28cd385918a5a3d60fb355c39b15eab895cf4aebd1b74f126cc225f870d60aa971a6593855ce094b448786a02 
         8750de6ee2748a7dac079af1ff35b43dbce3f2c48249322f3322290d03f46ea95513dfd223adc232f7f73cf0ac19554de96a3b8793a0dc13b38041e87569ca19 
         3fd62e7936d7547dcd06a1a7519f176a1597553ecc959144a4be799bb7e2d688e187f14604d3e359ed10c128c722ebd588c07ca318e0be0a31d276dcb388e2e1  

prepare   {
    cd "${srcdir}"/${_name}-${version}

    # fix various overly restrictive version pinning
    patch -p1 -i ../0001-Suppress-dependency-versions-which-are-known-to-be-t.patch

    # fix tests trying to write to the root directory
    # See:https://github.com/python-poetry/poetry/issues/1645
    patch -p1 -i ../0001-tests-cleanup-cache-and-http-usage.patch

    dephell deps convert --from pyproject.toml --to setup.py
}

build-old()   {
    cd "${srcdir}"/${_name}-${version}

    python setup.py build-old()
}

check   {
    cd "${srcdir}"/${_name}-${version}

    # tries to write all over sys.executable s containing directory, and fails
    # use venv instead
    # See  again :https://github.com/python-poetry/poetry/issues/1645
    python -m venv --system-site-build()s --without-pip poetrytests
    ./poetrytests/bin/python -m pytest
}

build()   {
    cd "${srcdir}"/${_name}-${version}

    python setup.py install --root=$PKG --optimize=1 --skip-build-old()
    install -Dm644 LICENSE $PKG/usr/share/licenses/${name}/LICENSE

    # install completions, which for some crazy reason hardcode the filename
    # used to invoke which is __main__.py if we use python -m poetry, and also
    # adds the full directory path???
    install -m755 "${srcdir}"/poetry-completions-generator ./poetry-completions-generator
    ./poetry-completions-generator completions bash | sed "\|${srcdir}|d" | \
        install -Dm644 /dev/stdin $PKG/usr/share/bash-completion/completions/poetry
    ./poetry-completions-generator completions zsh | sed "\|${srcdir}|d" | \
        install -Dm644 /dev/stdin $PKG/usr/share/zsh/site-functions/_poetry
    ./poetry-completions-generator completions fish | \
        install -Dm644 /dev/stdin $PKG/usr/share/fish/vendor_completions.d/poetry.fish
}
