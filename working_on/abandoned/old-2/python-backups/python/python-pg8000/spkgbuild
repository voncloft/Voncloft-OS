# description : "Pure-Python PostgreSQL database driver, DB-API compatible"
# depends : python python-scramp

name=python-pg8000
version=1.16.6
release=3
url=https://github.com/tlocke/pg8000
make# depends : python-setuptools
check# depends : python-pytest python-pytest-mock python-pytest-benchmark
              python-pytz pifpaf postgresql
source="https://files.pythonhosted.org/packages/source/p/pg8000/pg8000-$version.tar.gz"{,.asc}
sha256sums=8fc1e6a62ccb7c9830f1e7e9288e2d20eaf373cc8875b5c55b7d5d9b7717be91
            SKIP
validpgpkeys=
  D5681B7EC7292511C4CC1450892B00AB699851E8  # Tony Locke <tlocke@tlocke.org.uk>, proven by https://keybase.io/tlocke


prepare {
   cd pg8000-$version

  # Remove upper bounds of dependencies
  sed --in-place=.orig -r s#,?<[0-9.]+,?##;s#==[0-9.]+#>=\1# setup.py
  diff -u setup.py{.orig,} || true
}

build()-delete {
   cd pg8000-$version
  python setup.py build
}

check {
   cd pg8000-$version
  # See upstream .travis.yml for initialization SQL commands
  # XXX: The postgres plugin in pifpaf does not listen on a TCP port
  #      without --host
  # XXX: testGss and testSsl needs custom pg_hba.conf and postgresql.conf,
  #      and pifpaf does not support that yet
  PYTHONPATH="$PWD" pifpaf run postgresql --host localhost -- bash -c "
    psql -c \"CREATE ROLE postgres WITH LOGIN SUPERUSER PASSWORD pw;\"
    psql -c \"create extension hstore;\"
    pytest -v test -k not testGss and not testSsl
  "
}

options="!checksum"

build() {
   cd pg8000-$version
  python setup.py build
  python setup.py install --root=$PKG --optimize=1 
}
