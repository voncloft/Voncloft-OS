# description : "A python plotting library, making publication quality plots"
# depends : freetype2 python-cycler python-dateutil python-kiwisolver python-numpy python-pillow python-pyparsing qhull

name=python-matplotlib
version=3.3.4
release=1
url="https://matplotlib.org"
opt# depends : tk: Tk{Agg,Cairo} backends
            python-pyqt5: Qt5{Agg,Cairo} backends
            python-gobject: for GTK3{Agg,Cairo} backend
            python-wxpython: WX{,Agg,Cairo} backend
            python-cairo: {GTK3,Qt5,Tk,WX}Cairo backends
            python-cairocffi: alternative for Cairo backends
            python-tornado: WebAgg backend
            ffmpeg: for saving movies
            imagemagick: for saving animated gifs
            ghostscript: usetex dependencies
            texlive-bin: usetex dependencies
            texlive-latexextra: usetex usage with pdflatex
            python-certifi: https support
make# depends : git rsync python-setuptools
             tk python-pyqt5 python-gobject
             python-wxpython python-cairocffi
             python-certifi python-tornado
             ghostscript texlive-bin
             # agg missing some non-upstreamed patches?
check# depends : python-pytest-xdist python-pytest-runner xorg-server-xvfb
              texlive-core texlive-latexextra inkscape mencoder
              ffmpeg imagemagick python-pandas
source="https://github.com/matplotlib/matplotlib/archive/v${version}/${name}-${version}.tar.gz"
sha512sums=e29bcd17ea2b65c26c75421a319d3f21c5b0148c9e61d55d719c191c07342ed19032f97cde269647bd545ed45b5e142483e50caf29ffd421acde5b0b3bfa238b

prepare {
   cd matplotlib-${version}
# Use system freetype and qhull
  sed -e s|#system_freetype = False|system_freetype = True| -e s|#system_qhull = False|system_qhull = True| setup.cfg.template > setup.cfg
}

build()-delete {
   cd matplotlib-${version}
  python setup.py build
}

check {
   cd matplotlib-${version}
  xvfb-run -a -s "+extension GLX +extension RANDR +render -screen 0 1280x1024x24" \
    python setup.py pytest --addopts="-n auto" || echo "Tests failed" # Different font rendering details
}

package_python-matplotlib {
   cd matplotlib-${version}
  python setup.py build
  python setup.py install --root "${PKG}" --optimize=1 
  install -Dm644 doc/users/license.rst -t "${PKG}"/usr/share/licenses/${name}/
  # Needed since https://github.com/matplotlib/matplotlib/pull/14170
  rm -r "${PKG}"$python -c "import site; printsite.getsitepackages[0]"/{matplotlib,mpl_toolkits}/tests/
}
