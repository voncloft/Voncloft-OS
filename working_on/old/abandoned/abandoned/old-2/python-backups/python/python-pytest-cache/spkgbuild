# description : pytest plugin with mechanisms for caching across test runs

pkgbase=python-pytest-cache
_name=pytest-cache
version=1.0
release=8
url=https://pypi.org/project/pytest-cache/
source=https://files.pythonhosted.org/packages/source/${_name::1}/$_name/$_name-$version.tar.gz
sha256sums=be7468edd4d3d83f1e844959fd6e3fd28e77a481440a7118d430130ea31b07a9

prepare {
  cp -a "${srcdir}/${_name}-${version}"{,-py2}
}

build()-delete {
   cd "$srcdir/$_name-$version"
  python setup.py build

   cd "$srcdir/$_name-$version-py2"
}

check {
  # Hack entry points by installing it

   cd "$srcdir/$_name-$version"
  python setup.py build
  python setup.py install --root="$PWD/tmp_install" --optimize=1
  PYTHONPATH="$PWD/tmp_install/usr/lib/python3.9/site-packages:$PYTHONPATH" py.test

   cd "$srcdir/$_name-$version-py2"
   || echo "Tests failed"
  # Skipping tests as its incompatibility with pytest 2.8.0, not python 3.5.
  # https://bitbucket.org/hpk42/pytest-cache/issues/11/tests-failed-with-pytest-280
}

package_python-pytest-cache {
  # depends : python-pytest python-execnet

   cd "$srcdir/$_name-$version"
  python setup.py build
  python setup.py install --root=$PKG/ --optimize=1
}


   cd "$srcdir/$_name-$version-py2"
}
