# description : Plugin for nose or py.test that automatically reruns flaky tests

pkgbase=python-flaky
version=3.7.0
release=3
url=https://github.com/box/flaky
source="$pkgbase-$version.tar.gz::https://github.com/box/flaky/archive/v$version.tar.gz"
sha512sums=20ec44c721aa68aad07b5669a3b23b7551380ef5cddecf9cc6197bbf78c5b1a823887046394aa6c4a66011e1a31c78b02c3cc89e96775498b600f20211ce7b99

prepare {
  cp -a flaky-$version{,-py2}
}

build()-delete {
   cd "$srcdir"/flaky-$version
  python setup.py build

   cd "$srcdir"/flaky-$version-py2
}

check {
  # Hack entry points by installing it

   cd "$srcdir"/flaky-$version
  python setup.py build
  python setup.py install --root="$PWD/tmp_install" --optimize=1
  
    export PYTHONPATH="$PWD/tmp_install/usr/lib/python3.6/site-packages:$PYTHONPATH"
    nosetests3 --with-flaky --exclude="test_nose_options_example" test/test_nose/
    py.test -k example and not options --doctest-modules test/test_pytest/
    py.test -p no:flaky test/test_pytest/test_flaky_pytest_plugin.py
    nosetests3 --with-flaky --force-flaky --max-runs 2 test/test_nose/test_nose_options_example.py
    py.test --force-flaky --max-runs 2 test/test_pytest/test_pytest_options_example.py
  

   cd "$srcdir"/flaky-$version-py2
  
    nosetests2 --with-flaky --exclude="test_nose_options_example" test/test_nose/
    py.test2 -k example and not options --doctest-modules test/test_pytest/
    py.test2 -p no:flaky test/test_pytest/test_flaky_pytest_plugin.py
    nosetests2 --with-flaky --force-flaky --max-runs 2 test/test_nose/test_nose_options_example.py
    py.test2 --force-flaky --max-runs 2 test/test_pytest/test_pytest_options_example.py
  
}

package_python-flaky {
  # depends : python

   cd "$srcdir"/flaky-$version
  python setup.py build
  python setup.py install --root=$PKG --optimize=1
}


   cd "$srcdir"/flaky-$version-py2
}

