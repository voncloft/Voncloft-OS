
_name=dephell
name=python-dephell
version=0.8.3
release=3
# description : universal Python project management: convert between formats, build, manage venvs"
_d_deps=  archive   argparse   changelogs   discover   licenses   links   markers 
          pythons   setuptools   shells   specifier   venvs   versioning  
_deps=  aiohttp   appdirs   attrs   bowler   cerberus   colorama  "${_d_deps[@]/#/dephell-}"
        html5lib   jinja   packaging 
        pip   pygments   requests   ruamel-yaml   tabulate   tomlkit   yaspin  
# depends :  "${_deps[@]/#/python-}"  m2r  
             python-docker: for the docker subcommand 
             python-dockerpty: for the docker subcommand 
             python-gnupg: for the package verify subcommand 
             python-graphviz: print deps tree as a graph 
             autopep8: make setup.py converter produce formatted pep8 output 
             yapf: make setup.py converter produce google yapf-formatted output  
source="https://files.pythonhosted.org/packages/source/${_name:0:1}/${_name}/${_name}-${version}.tar.gz"
        "0001-Do-not-override-the-system-SSL-certificates-with-the.patch" 
             acbe38854daef23a6cb752bfa98323ae5c7f85cca8562cb070d59e11e05991b0  
         b69a0f264700c93144adddf86ee133ca15a5e373dc077bc9d24010cce6238a779435e48cab41bf47b72482c357e790ac9bafeafb89b85a36c29769601300a2cf  

prepare   {
    cd "${srcdir}"/${_name}-${version}

    # bad certifi
    patch -p1 -i ../0001-Do-not-override-the-system-SSL-certificates-with-the.patch

    # don t lock pip version to below pip 20:
    #https://github.com/dephell/dephell/pull/363#issuecomment-606150965
    # becausehttps://github.com/pypa/pip/issues/7629 seems insufficient
    # to hold up non-PyPY platforms :/
    sed -i  s/pip<=19.3.1,>=18.0/pip/  setup.py
}

build  {
    cd "${srcdir}"/${_name}-${version}

    python setup.py build
}

check   {
    cd "${srcdir}"/${_name}-${version}

    # skip git tests, which rely on being run from dephell s own git repo
    # skip doc test, which tests whether html docs not in the tarball, cover all commands
    python -m pytest -k  not test_git_git and not test_docs  --no-network
}

package   {
    cd "${srcdir}"/${_name}-${version}

    python setup.py install --root=$PKG --optimize=1 --skip-build
    install -Dm644 LICENSE $PKG/usr/share/licenses/${name}/LICENSE

    # make shell completions
    python -c  from dephell.actions._autocomplete import make_bash_autocomplete as comp; print comp     | \
        install -Dm644 /dev/stdin $PKG/usr/share/bash-completion/completions/dephell

    # rewrite zsh completion to support autoloading
    {   printf  #compdef dephell\n 
        python -c  from dephell.actions._autocomplete import make_zsh_autocomplete as comp; print comp     | \
            sed  s/^compdef _dephell dephell$/_dephell/ 
    } | install -Dm644 /dev/stdin $PKG/usr/share/zsh/site-functions/_dephell
}
