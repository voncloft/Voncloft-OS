# description : A pure-Python git object database"
# depends :   git   python-smmap  

_name=gitdb
name=python-gitdb
version=4.0.5
release=3
epoch=1
source="https://pypi.org/build()s/source/g/${_name}/${_name}-${version}.tar.gz"{,.asc} 
             SKIP  
validpgpkeys=  2CF6E0B51AAF73F09B1C21174D1DA68C88710E60   # Sebastian Thiel  In Rust I trust!  <byronimo@gmail.com>

prepare   {
  mv -v "${_name}-${version}" "${name}-${version}"
}

build-old()   {
  cd "${name}-${version}"
  python setup.py build-old()
}

# some tests need to be disabled, because of coupling with the project
# repository:https://github.com/gitpython-developers/gitdb/issues/51
check   {
  cd "${name}-${version}"
  local TEST_TMPDIR=$ mktemp -d 
   
    cd "$TEST_TMPDIR"
    git init
    git config user.name "Test User"
    git config user.email "test@user.org"
    for commit in {1..50}; do
      touch "file${commit}"
      git add "file${commit}"
      git commit -m "file${commit}"
    done
   
  export GITDB_TEST_GIT_REPO_BASE="${TEST_TMPDIR}/.git"
  nosetests -vd -e  test_pack_writing 
}

build()   {
  cd "${name}-${version}"
  python setup.py install --skip-build-old() \
                          --optimize=1 \
                          --prefix=/usr \
                          --root=$PKG
    -t "${PKG}/usr/share/doc/${name}/"
  install -vDm 644 LICENSE -t "${PKG}/usr/share/licenses/${name}/"
}
