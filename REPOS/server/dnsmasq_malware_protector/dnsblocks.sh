#!/bin/bash

# Function to display help
show_help() {
  cat << EOF
Usage: $(basename "$0") [logfile or pattern]

Description:
  This script analyzes dnsmasq logs and counts NXDOMAIN occurrences by domain.

Options:
  -h            Show this help message.
  [logfile]     Specify a log file or wildcard pattern to analyze.
                If no file is provided, defaults to /var/log/dnsmasq.log.

Examples:
  $(basename "$0")                 # Uses /var/log/dnsmasq.log
  $(basename "$0") /var/log/dnsmasq.log.1
  $(basename "$0") "*/*/dnsmasq.log.1"

EOF
}

# Check for -h flag
if [[ "$1" == "-h" ]]; then
  show_help
  exit 0
fi

# Default log file path
default_log="/var/log/dnsmasq.log"

# Use provided argument or default
log_pattern="${1:-$default_log}"

# Expand wildcards using find
log_files=( $(find / -path "$log_pattern" 2>/dev/null) )

# Check if any files matched
if [ ${#log_files[@]} -eq 0 ]; then
  echo "No log files found matching: $log_pattern"
  exit 1
fi

# Process matched files
for logfile in "${log_files[@]}"; do
  echo "Processing: $logfile"
  grep "NXDOMAIN" "$logfile" | \
  awk '{for (i=1; i<=NF; i++) if ($i ~ /^[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/) print tolower($i)}'
done | sort | uniq -c | sort -nr
