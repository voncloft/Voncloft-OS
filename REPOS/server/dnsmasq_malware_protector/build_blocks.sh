#!/bin/sh

# Base directory for temporary files
TMP_LOCATION=/tmp
DNSMASQ_CONF_DIR=/etc/dnsmasq.d
build_host_files()
{

# List of URLs to download hosts files
HOSTS_LIST="
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/hostsVN/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/adaway.org/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/add.2o7Net/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/add.Risk/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/add.Spam/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/add.Dead/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/KADhosts/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/mvps.org/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/someonewhocares.org/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/UncheckyAds/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/yoyo.org/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/Badd-Boyz-Hosts/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/URLHaus/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/StevenBlack/hosts
https://raw.githubusercontent.com/StevenBlack/hosts/refs/heads/master/data/tiuxo/hosts
"

# Download each hosts file and create corresponding dnsmasq configuration
for HOSTS_RAW in $HOSTS_LIST; do
  # Extract the filename from the URL
  FILENAME=$(basename $HOSTS_RAW)
  
  # Extract the unique identifier (e.g., mvps.org) from the URL
  IDENTIFIER=$(echo $HOSTS_RAW | grep -oP '(?<=data/)[^/]+')
  
  # Temporary file for the downloaded hosts
  TMP_FILE=$TMP_LOCATION/$FILENAME
  
  # Output dnsmasq configuration file
  CONF_FILE=$DNSMASQ_CONF_DIR/$IDENTIFIER.conf

  echo "Downloading $HOSTS_RAW..."
  wget -q $HOSTS_RAW -O $TMP_FILE

  if [ -s $TMP_FILE ]; then
    # Generate dnsmasq configuration for IPv4
    awk '$1 == "0.0.0.0" || $1 == "127.0.0.1" { print "address=/"$2"/0.0.0.0/"}' $TMP_FILE > $CONF_FILE
    # For IPv6 support, uncomment the following line
    awk '$1 == "0.0.0.0" || $1 == "127.0.0.1" { print "address=/"$2"/::1/"}' $TMP_FILE >> $CONF_FILE

    echo "Created $CONF_FILE"
  else
    echo "Failed to download or empty file: $HOSTS_RAW"
  fi

  # Clean up temporary file
  rm -f $TMP_FILE
done
if [ -f "$DNSMASQ_CONF_DIR/.conf" ]; then
  mv -v "$DNSMASQ_CONF_DIR/.conf" "$DNSMASQ_CONF_DIR/default.conf"
fi

echo "All dnsmasq configurations updated!"
#/etc/init.d/dhcpd restart
}
build_adblock()
{
#DNSMASQ_CONF_DIR=/etc/dnsmasq.d
echo $DNSMASQ_CONF_DIR
echo "Grabbing Adblocklist"
wget -q -nv https://easylist-downloads.adblockplus.org/easylist.txt -O /temp/adblocklist
egrep '^\|\|([a-zA-Z\.]+)\^$' /temp/adblocklist | cut -d '^' -f1 | sed 's#||#address=/# ; s#$#/0.0.0.0/#' | sort | uniq > $DNSMASQ_CONF_DIR/adblock.conf
rm /temp/adblocklist
}

restart_dnsmasq()
{
/etc/init.d/dhcpd restart
}

run_default()
{
build_host_files
build_adblock
restart_dnsmasq
}
"$@"
