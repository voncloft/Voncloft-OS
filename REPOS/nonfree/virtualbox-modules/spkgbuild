# description	: Virtualbox host kernel modules
# depends	: dkms
name=virtualbox-modules
version=6.1.36
release=1
_version=${version%.*}
_name=Oracle_VM_VirtualBox_Extension_Pack
_release=152435

source="http://download.virtualbox.org/virtualbox/$version/VirtualBox-${version}-${_release}-Linux_amd64.run
	buildmodules-vboxhost.sh
	dkms.conf"

build() {
	sh VirtualBox-${version}-${_release}-Linux_amd64.run --keep --noexec --target $PWD
	tar xf VirtualBox.tar.bz2 src/vboxhost/	

	if [ -f /lib/modules/KERNELVERSION ]; then
		kernver=$(cat /lib/modules/KERNELVERSION)
	else
		kernver=$(uname -r)
	fi

	cd src/vboxhost/
	KERN_VER=$kernver KERN_DIR=/usr/lib/modules/$kernver/build make

	for i in *.ko; do
	    install -Dm0644 $i $PKG/lib/modules/$kernver/kernel/misc/$i
	done


# dkms
	install -d $PKG/usr/src/
	mkdir $PKG/usr/src/vboxhost-$_version
	sed "s,@VERSION@,$_version," $SRC/dkms.conf > $PKG/usr/src/vboxhost-$_version/dkms.conf
	#rm -fr $PKG/opt/VirtualBox/src/

	# dkms build modules script
	mkdir -p $PKG/var/lib/dkms
	sed -e "s/@name@/vboxhost/g" \
	    -e "s/@version@/$_version/g" \
	$SRC/buildmodules-vboxhost.sh > $PKG/var/lib/dkms/buildmodules-vboxhost.sh

	install -d $PKG/etc/modules-load.d/
	echo "# Load virtualbox modules at startup" > $PKG/etc/modules-load.d/virtualbox.conf
	echo "vboxdrv" >> $PKG/etc/modules-load.d/virtualbox.conf
	echo "vboxnetadp" >> $PKG/etc/modules-load.d/virtualbox.conf
	echo "vboxnetflt" >> $PKG/etc/modules-load.d/virtualbox.conf
	echo "vboxpci" >> $PKG/etc/modules-load.d/virtualbox.conf

	# compress modules
	find $PKG -name '*.ko' -exec xz -T1 {} +
}
